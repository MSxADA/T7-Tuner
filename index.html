<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Douk T7 Ultimate Tuner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body {
            background-color: #020617; /* Slate 950 */
            color: white;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .knob-rotate { transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }
        /* Hide Scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            width: 36px; height: 36px; border-radius: 50%;
            border-left-color: #38bdf8;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- Loading / Error Fallback -->
    <div id="root">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8;">
            <div class="spinner"></div>
            <p style="margin-top: 20px; font-family: monospace;">LOADING TUNER...</p>
            <p style="font-size: 12px; opacity: 0.5; margin-top: 10px;">If this takes longer than 5 seconds, something is wrong.</p>
        </div>
    </div>

    <!-- Error Handler Script -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            root.innerHTML = `
                <div style="padding: 20px; color: #f87171; font-family: monospace; text-align: center; margin-top: 50px;">
                    <h2 style="font-size: 24px; color: white;">⚠️ App Crashed</h2>
                    <p style="margin-bottom: 20px;">The Tuner failed to start. Here is the error:</p>
                    <div style="background: #1e293b; padding: 15px; border-radius: 8px; text-align: left; display: inline-block;">
                        ${message}
                    </div>
                </div>
            `;
        };
    </script>

    <script type="text/babel">
        const { useState } = React;

        // --- ICONS ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                headphones: <path d="M3 14v-3a9 9 0 0 1 18 0v3M3 19a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2h-2zM17 14a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2h-2z" />,
                speaker: <path d="M12 6L8 10H4v4h4l4 4V6zM17 7a5 5 0 0 1 0 10M15.5 10.5a2.5 2.5 0 0 1 0 3" />,
                music: <path d="M9 18V5l12-2v13M9 9l12-2M6 18a3 3 0 1 0 0-6 3 3 0 0 0 0 6zM18 16a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
                sliders: <path d="M4 21v-7M4 10V3M12 21v-9M12 8V3M20 21v-5M20 12V3M1 14h6M9 8h6M17 16h6" />,
                info: <><circle cx="12" cy="12" r="10" /><line x1="12" y1="16" x2="12" y2="12" /><line x1="12" y1="8" x2="12.01" y2="8" /></>,
                check: <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || icons.info}
                </svg>
            );
        };

        const DoukT7Visualizer = () => {
            const MIN_DEG = -150;
            const MAX_DEG = 150;
            const MIN_DB = -6;
            const MAX_DB = 6;

            // --- CONFIG ---
            const outputs = {
                lcd2c: { id: 'lcd2c', name: "Audeze LCD-2C", desc: "Warm & Dark Planar. Needs upper-mids & air.", accent: "#f59e0b", icon: "headphones" },
                arya: { id: 'arya', name: "Hifiman Arya", desc: "Bright & Airy Planar. Needs bass warmth & anti-glare.", accent: "#22d3ee", icon: "headphones" },
                stereo: { id: 'stereo', name: "Def Tech DM60", desc: "Stereo Mode. Tuned for Bipolar Towers & Room Acoustics.", accent: "#10b981", icon: "speaker" }
            };

            const [selectedOutput, setSelectedOutput] = useState('lcd2c');
            const [activePresetKey, setActivePresetKey] = useState('neutral');
            const [activeCategory, setActiveCategory] = useState('calibration');

            // --- PRESETS DATABASE [LCD, Arya, Stereo] ---
            const presets = {
                calibration: {
                    title: "Base Calibration", icon: "info",
                    items: {
                        neutral: { name: "Stock / Neutral", desc: { lcd2c: "Restores mids/air.", arya: "Tames glare.", stereo: "Balanced room response." }, vals: { 64:[0,1,0], 125:[0,0,-1.5], 250:[0,0,0], 500:[0,0,0.5], '2k':[1.5,0,-1], '4k':[4.5,-2,-1], '8k':[3,-3,0] } }
                    }
                },
                styles: {
                    title: "Listening Styles", icon: "sliders",
                    items: {
                        warmth: { name: "Fuller Bass & Warmth", desc: { lcd2c: "Thickens low end.", arya: "Adds body.", stereo: "Tube warmth." }, vals: { 64:[3.5,4.5,2], 125:[4,4,3], 250:[2,2,2], 500:[0,0,0], '2k':[-1,-1,-1], '4k':[-1,-3,-2], '8k':[0,-3,-2] } },
                        energetic: { name: "Energetic & Forward", desc: { lcd2c: "Vocals closer.", arya: "Aggressive detail.", stereo: "Live concert feel." }, vals: { 64:[1,2,1], 125:[0,1,0], 250:[-1,0,-1], 500:[0,-1,0], '2k':[2,0,1], '4k':[3,-1,1], '8k':[4,1,2] } },
                        crisp: { name: "Crisp & Detailed", desc: { lcd2c: "Max clarity.", arya: "Detail w/o hiss.", stereo: "Vocal clarity focus." }, vals: { 64:[0,1,0], 125:[-1,0,-2], 250:[0,0,-1], 500:[-2.5,-1,-1], '2k':[0,-1,0], '4k':[3,0,-1], '8k':[5,-2,0] } },
                        smooth: { name: "Smooth & Relaxed", desc: { lcd2c: "Anti-shout.", arya: "De-Esser.", stereo: "Late night lounge." }, vals: { 64:[1,2.5,1], 125:[1,2,1], 250:[0,1,0], 500:[0,0,0], '2k':[-3.5,-2,-2], '4k':[-1,-4,-2], '8k':[2,-4,-3] } },
                        latenight: { name: "Late Night", desc: { lcd2c: "Loudness contour.", arya: "Low vol fullness.", stereo: "Low vol clarity." }, vals: { 64:[4.5,5,3], 125:[3,3,1], 250:[1,1,1], 500:[0,0,0], '2k':[-1,-1,-1], '4k':[2,-1,-1], '8k':[5,1,0] } },
                        theater: { name: "Theater / Cinema", desc: { lcd2c: "Rumble & dialogue.", arya: "Cinematic weight.", stereo: "Blockbuster mode." }, vals: { 64:[5,6,4], 125:[2,3,1], 250:[0,1,0], 500:[-2,-1,-1], '2k':[2,0,2], '4k':[3,-1,0], '8k':[4,0,2] } }
                    }
                },
                genres: {
                    title: "Music Genres", icon: "music",
                    items: {
                        classicrock: { name: "Classic Rock", desc: { lcd2c: "Groove mode.", arya: "Vintage warmth.", stereo: "70s Hi-Fi sound." }, vals: { 64:[2,3,1], 125:[3.5,4,3], 250:[1,2,1], 500:[-1.5,-1,-1], '2k':[-3.5,-2,-2], '4k':[0,-2,-1], '8k':[3,-1,1] } },
                        pop: { name: "Pop", desc: { lcd2c: "Fun V-Shape.", arya: "Bass boost.", stereo: "Radio ready." }, vals: { 64:[3,4,2], 125:[1,2,0], 250:[-1,0,-1], 500:[-1,-1,0], '2k':[0,-1,-1], '4k':[2,-1,-1], '8k':[4,0,1] } },
                        metal: { name: "Metal", desc: { lcd2c: "Impact / Anti-shout.", arya: "Bass slam.", stereo: "Double-kick power." }, vals: { 64:[4,5,4], 125:[1.5,3,0], 250:[0,1,0], 500:[-2,-1,-1], '2k':[-3,-2,-3], '4k':[0.5,-2,0], '8k':[4,-1,1] } },
                        stoner: { name: "Stoner Metal", desc: { lcd2c: "Wall of fuzz.", arya: "Thick atmosphere.", stereo: "Warm & Heavy." }, vals: { 64:[2.5,4,2], 125:[4.5,5,2], 250:[3,3,1], 500:[0,1,1], '2k':[-2,-2,-2], '4k':[-1,-3,-2], '8k':[1,-3,-2] } },
                        jazz: { name: "Jazz", desc: { lcd2c: "Cymbal detail.", arya: "Double bass.", stereo: "Smoke-filled room." }, vals: { 64:[1,2,0], 125:[2.5,3,2], 250:[0,1,1], 500:[-1,0,0], '2k':[-2.5,-2,-1], '4k':[1,-2,-2], '8k':[3.5,-1,1] } },
                        acoustic: { name: "Acoustic", desc: { lcd2c: "String texture.", arya: "Natural.", stereo: "Clear vocals." }, vals: { 64:[0,1,0], 125:[-2,0,-2], 250:[0,0,-1], 500:[-1,-1,-1], '2k':[0,-1,-1], '4k':[2.5,0,-1], '8k':[4.5,1,0] } },
                        classical: { name: "Classical", desc: { lcd2c: "Soundstage.", arya: "Cello weight.", stereo: "Concert Hall." }, vals: { 64:[0.5,2,1], 125:[0,1,-1], 250:[0,0,0], 500:[0,0,0], '2k':[1,0,-1], '4k':[2,-1,-2], '8k':[4,0,-1] } },
                        electronic: { name: "Electronic", desc: { lcd2c: "Sub-bass party.", arya: "Bass cannon.", stereo: "Club mode." }, vals: { 64:[5.5,6,5], 125:[2,3,1], 250:[-1,0,-1], 500:[-2,-1,-2], '2k':[-1,-1,0], '4k':[2,0,1], '8k':[5,1,3] } },
                        rnb: { name: "R&B", desc: { lcd2c: "Silky vocals.", arya: "Smooth & Deep.", stereo: "Lounge vibes." }, vals: { 64:[2.5,3.5,2], 125:[3,3.5,1], 250:[1,1,0], 500:[0,0,0], '2k':[-1.5,-1,-1], '4k':[0,-2,-1], '8k':[3,-2,-1] } },
                        rap: { name: "Rap", desc: { lcd2c: "808s.", arya: "Beat impact.", stereo: "Sub-bass focus." }, vals: { 64:[5,6,4], 125:[1,2,0], 250:[0,0,-1], 500:[-1,-1,-1], '2k':[1.5,0,0], '4k':[1,-1,-1], '8k':[3,-1,0] } },
                        country: { name: "Country", desc: { lcd2c: "Twang.", arya: "Body adder.", stereo: "Vocal forward." }, vals: { 64:[1,2,1], 125:[2,2.5,0], 250:[2,1,1], 500:[-1,0,-1], '2k':[1.5,-1,-1], '4k':[2.5,-1,-1], '8k':[2,-1,0] } },
                        funk: { name: "Funk & Soul", desc: { lcd2c: "Bass guitar.", arya: "Groove.", stereo: "Tight bass." }, vals: { 64:[2,3,2], 125:[4,4,2], 250:[0,1,0], 500:[-1,-1,-1], '2k':[0,-1,-1], '4k':[2.5,0,-1], '8k':[3,0,1] } },
                        reggae: { name: "Reggae", desc: { lcd2c: "Earth shaking.", arya: "Island warmth.", stereo: "Max warmth." }, vals: { 64:[4.5,5.5,4], 125:[5,5,3], 250:[1,2,1], 500:[0,0,0], '2k':[-1,-1,-1], '4k':[-1,-2,-2], '8k':[1,-2,-2] } }
                    }
                }
            };

            const getIndex = (id) => id === 'lcd2c' ? 0 : id === 'arya' ? 1 : 2;
            const handleOutputSwitch = (id) => { setSelectedOutput(id); setActivePresetKey('neutral'); setActiveCategory('calibration'); };

            const activeOutput = outputs[selectedOutput];
            const allItems = { ...presets.calibration.items, ...presets.styles.items, ...presets.genres.items };
            const activePresetData = allItems[activePresetKey];
            
            // Safety: default to neutral if something goes wrong
            const currentValues = {};
            const idx = getIndex(selectedOutput);
            if (activePresetData) {
                Object.keys(activePresetData.vals).forEach(k => {
                    currentValues[k] = activePresetData.vals[k][idx] !== undefined ? activePresetData.vals[k][idx] : activePresetData.vals[k][0];
                });
            }

            return (
                <div className="min-h-screen flex flex-col items-center p-4 md:p-8">
                    <div className="text-center mb-8">
                        <h1 className="text-4xl md:text-5xl font-black text-white mb-2 tracking-tight">
                            DOUK T7 <span style={{ color: activeOutput.accent }}>TUNER</span>
                        </h1>
                        <p className="text-slate-500 text-xs font-bold uppercase tracking-[0.3em]">Ultimate Calibration</p>
                    </div>

                    {/* OUTPUTS */}
                    <div className="w-full max-w-4xl grid grid-cols-3 gap-2 md:gap-4 mb-8">
                        {Object.values(outputs).map((out) => {
                            const isSelected = selectedOutput === out.id;
                            return (
                                <button key={out.id} onClick={() => handleOutputSwitch(out.id)}
                                    className="relative p-3 md:p-4 rounded-xl border-2 transition-all duration-300 flex flex-col items-center gap-2 overflow-hidden group"
                                    style={{
                                        borderColor: isSelected ? out.accent : '#1e293b',
                                        backgroundColor: isSelected ? 'rgba(15, 23, 42, 0.8)' : 'rgba(15, 23, 42, 0.4)',
                                        boxShadow: isSelected ? `0 0 20px ${out.accent}20` : 'none'
                                    }}
                                >
                                    <div className="absolute top-0 left-0 w-full h-1" style={{ background: `linear-gradient(90deg, transparent, ${out.accent}, transparent)`, opacity: isSelected ? 1 : 0 }}></div>
                                    <div style={{ color: isSelected ? out.accent : '#64748b' }}><Icon name={out.icon} size={20} /></div>
                                    <span className={`font-bold text-xs md:text-sm ${isSelected ? 'text-white' : 'text-slate-400'}`}>{out.name}</span>
                                </button>
                            );
                        })}
                    </div>

                    <div className="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* PRESETS COLUMN */}
                        <div className="lg:col-span-4 flex flex-col gap-6">
                            <PresetGroup title={presets.styles.title} icon={presets.styles.icon} items={presets.styles.items} activeKey={activePresetKey} onSelect={(k) => { setActiveCategory('styles'); setActivePresetKey(k); }} accent={activeOutput.accent} />
                            <PresetGroup title={presets.genres.title} icon={presets.genres.icon} items={presets.genres.items} activeKey={activePresetKey} onSelect={(k) => { setActiveCategory('genres'); setActivePresetKey(k); }} accent={activeOutput.accent} />
                        </div>

                        {/* VISUALIZER COLUMN */}
                        <div className="lg:col-span-8">
                            <div className="w-full bg-slate-900 rounded-3xl border border-slate-700 p-6 md:p-10 shadow-2xl relative overflow-hidden min-h-[500px] flex flex-col justify-center">
                                <div className="absolute top-0 left-0 w-full h-1 opacity-60" style={{ background: `linear-gradient(90deg, transparent, ${activeOutput.accent}, transparent)` }}></div>
                                <div className="absolute -top-40 -right-40 w-96 h-96 rounded-full blur-3xl pointer-events-none" style={{ background: activeOutput.accent, opacity: 0.05 }}></div>

                                <div className="mb-12 relative z-10">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-2xl md:text-3xl font-bold text-white">{activePresetData?.name || "Loading..."}</h2>
                                        <span className="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border"
                                              style={{ borderColor: activeOutput.accent, color: activeOutput.accent, backgroundColor: `${activeOutput.accent}10` }}>
                                            {activeOutput.name} Mode
                                        </span>
                                    </div>
                                    <div className="flex gap-3 border-l-2 border-slate-700 pl-4">
                                        <div className="mt-1" style={{ color: activeOutput.accent }}><Icon name="info" size={18} /></div>
                                        <p className="text-slate-300 text-sm leading-relaxed">{activePresetData?.desc[selectedOutput]}</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-y-12 gap-x-4 justify-items-center relative z-10">
                                    {[{l:'64 Hz',k:'64'},{l:'125 Hz',k:'125'},{l:'250 Hz',k:'250'},{l:'500 Hz',k:'500'},{l:'2 kHz',k:'2k'},{l:'4 kHz',k:'4k'},{l:'8 kHz',k:'8k'}].map((b) => (
                                        <Knob key={b.k} label={b.l} value={currentValues[b.k] || 0} accent={activeOutput.accent} minDb={MIN_DB} maxDb={MAX_DB} minDeg={MIN_DEG} maxDeg={MAX_DEG} />
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const PresetGroup = ({ title, icon, items, activeKey, onSelect, accent }) => (
            <div className="bg-slate-900/60 border border-slate-800 rounded-2xl p-5 shadow-lg backdrop-blur-sm">
                <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2"><Icon name={icon} size={16} />{title}</h3>
                <div className="grid grid-cols-2 gap-2">
                    {Object.entries(items).map(([key, item]) => {
                        const isActive = activeKey === key;
                        return (
                            <button key={key} onClick={() => onSelect(key)}
                                className="px-3 py-3 rounded-lg text-sm font-medium transition-all duration-200 text-left relative overflow-hidden"
                                style={{ backgroundColor: isActive ? '#1e293b' : 'transparent', color: isActive ? 'white' : '#94a3b8', border: '1px solid', borderColor: isActive ? `${accent}40` : 'transparent' }}>
                                <span className="relative z-10">{item.name}</span>
                                {isActive && <div className="absolute left-0 top-0 bottom-0 w-1" style={{ background: accent }}></div>}
                            </button>
                        );
                    })}
                </div>
            </div>
        );

        const Knob = ({ label, value, accent, minDb, maxDb, minDeg, maxDeg }) => {
            const ratio = (value - minDb) / (maxDb - minDb);
            const rotation = ratio * (maxDeg - minDeg) + minDeg;
            const isBoost = value > 0.1; const isCut = value < -0.1;
            const activeColor = isCut ? '#f43f5e' : (isBoost ? accent : '#64748b');
            const glowShadow = (isBoost || isCut) ? `0 0 15px ${activeColor}40` : 'none';
            const getClock = (v) => {
                if (Math.abs(v) < 0.2) return "12:00";
                let h = 12 + (v / 1.2); if (h > 12.99) h -= 12; if (h < 1) h += 12;
                let m = Math.round((h % 1) * 60); return `${Math.floor(h)}:${m < 10 ? '0'+m : m}`;
            };
            return (
                <div className="flex flex-col items-center w-full group">
                    <span className="text-[10px] font-bold uppercase tracking-widest mb-4 text-slate-500">{label}</span>
                    <div className="relative w-16 h-16">
                        <svg className="absolute inset-0 w-full h-full opacity-30" viewBox="0 0 100 100"><path d="M20 80 A 40 40 0 1 1 80 80" fill="none" stroke="currentColor" strokeWidth="6" strokeLinecap="round" /></svg>
                        <div className="w-14 h-14 bg-slate-800 rounded-full absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/
